name: Build .NET Framework Project

on:
  push:
    branches:
      - main
      - github-actions
  pull_request:
    branches:
      - main

jobs:
  build-job:
    runs-on: windows-latest

    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v3
      
      # Setup MSBuild
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2
      
      # Setup NuGet
      - name: Setup NuGet
        uses: nuget/setup-nuget@v2
      
      #- uses: actions/cache@v4
      #  id: cache
      #  with:
      #    path: ~/.nuget/packages
      #    key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}

      # Restore NuGet packages
      - name: Restore NuGet packages
        # if: steps.cache.outputs.cache-hit != 'true'
        run: nuget restore "source\Plugins.Filter.slnf"
      
      # Build the solution
      - name: Build solution
        run: msbuild "source\Plugins.Filter.slnf" /p:Configuration=Release

      # Copy dll to target directory
      - name: Create archives
        shell: pwsh
        run: source\zip-plugin-files.ps1

      # Upload plugins/artifacts
      - name: Upload HI2UC
        uses: ./.github/workflows/plugin-upload
        with:
          file-name: HI2UC

      - name: Upload HIColorer
        uses: ./.github/workflows/plugin-upload
        with:
          file-name: HIColorer

# won't work 'cause the two jobs are running in two difference instance of windows container
#  upload-job:
#    runs-on: windows-latest
#    needs: build-job
#    strategy:
#      matrix:
#        artifact_name: [ "HI2UC", "HIColorer" ]
#    steps:
#      - name: Checkout repository
#        uses: actions/checkout@v3
#
#      - name: Upload ${{matrix.artifact_name}}
#        uses: ./.github/workflows/plugin-upload
#        with:
#          file-name: ${{matrix.artifact_name}}